/*!
 * (C) Ionic http://ionicframework.com - MIT License
 * Built with http://stenciljs.com
 */
const{h:e}=window.Ionic;import{assert as t}from"./chunk3.js";import{attachComponent as i}from"./chunk7.js";import{lifecycle as n,transition as s}from"./chunk6.js";import r,{default$1 as o}from"./chunk8.js";class a{constructor(e,t){this.component=e,this.params=t,this.state=1}async init(e){if(this.state=2,!this.element){const t=this.component;this.element=await i(this.delegate,e,t,["ion-page","hide-page"],this.params)}}_destroy(){this.state;const e=this.element;e&&(this.delegate?this.delegate.removeViewFromDom(e.parentElement,e):e.remove()),this.nav=void 0,this.state=3}}function h(e,t,i){if(!e)return!1;if(e.component!==t)return!1;const n=e.params,s=null==n,r=null==i;if(s!==r)return!1;if(s&&r)return!0;const o=Object.keys(n),a=Object.keys(i);if(o.length!==a.length)return!1;for(let e=0;e<o.length;e++){const t=o[e];if(n[t]!==i[t])return!1}return!0}function l(e,t){return e?e instanceof a?e:new a(e,t):null}class d{constructor(){this.init=!1,this.transInstr=[],this.useRouter=!1,this.isTransitioning=!1,this.destroyed=!1,this.views=[]}rootChanged(){this.root&&(this.useRouter||this.setRoot(this.root,this.rootParams))}componentWillLoad(){this.useRouter=!!document.querySelector("ion-router")&&!this.el.closest("[no-router]"),void 0===this.swipeBackEnabled&&(this.swipeBackEnabled=this.config.getBoolean("swipeBackEnabled","ios"===this.mode)),void 0===this.animated&&(this.animated=this.config.getBoolean("animate",!0))}componentDidLoad(){this.rootChanged()}componentDidUnload(){for(const e of this.views)n(this.win,e.element,"ionViewWillUnload"),e._destroy();this.sbTrns&&this.sbTrns.destroy(),this.transInstr.length=this.views.length=0,this.sbTrns=void 0,this.destroyed=!0}push(e,t,i,n){return this.queueTrns({insertStart:-1,insertViews:[{page:e,params:t}],opts:i},n)}insert(e,t,i,n,s){return this.queueTrns({insertStart:e,insertViews:[{page:t,params:i}],opts:n},s)}insertPages(e,t,i,n){return this.queueTrns({insertStart:e,insertViews:t,opts:i},n)}pop(e,t){return this.queueTrns({removeStart:-1,removeCount:1,opts:e},t)}popTo(e,t,i){const n={removeStart:-1,removeCount:-1,opts:t};return e instanceof a?(n.removeView=e,n.removeStart=1):"number"==typeof e&&(n.removeStart=e+1),this.queueTrns(n,i)}popToRoot(e,t){return this.queueTrns({removeStart:1,removeCount:-1,opts:e},t)}removeIndex(e,t=1,i,n){return this.queueTrns({removeStart:e,removeCount:t,opts:i},n)}setRoot(e,t,i,n){return this.setPages([{page:e,params:t}],i,n)}setPages(e,t,i){return t||(t={}),!0!==t.animate&&(t.animate=!1),this.queueTrns({insertStart:0,insertViews:e,removeStart:0,removeCount:-1,opts:t},i)}setRouteId(e,t,i){const n=this.getActive();if(h(n,e,t))return Promise.resolve({changed:!1,element:n.element});const s=this.views.find(i=>h(i,e,t));let r;const o=new Promise(e=>r=e);let a;const l={updateURL:!1,viewIsReady:e=>{let t;const i=new Promise(e=>t=e);return r({changed:!0,element:e,markVisible:async()=>{t(),await a}}),i}};return a=s?this.popTo(s,Object.assign({},l,{direction:"back"})):1===i?this.push(e,t,l):-1===i?this.setRoot(e,t,Object.assign({},l,{direction:"back",animate:!0})):this.setRoot(e,t,l),o}getRouteId(){const e=this.getActive();return e?{id:e.element.tagName,params:e.params,element:e.element}:void 0}canGoBack(e=this.getActive()){return!(!e||!this.getPrevious(e))}getActive(){return this.views[this.views.length-1]}getByIndex(e){return this.views[e]}getPrevious(e=this.getActive()){if(!e)return;const t=this.views,i=t.indexOf(e);return i>0?t[i-1]:void 0}length(){return this.views.length}queueTrns(e,t){const i=new Promise((t,i)=>{e.resolve=t,e.reject=i});return e.done=t,e.insertViews&&0===e.insertViews.length&&(e.insertViews=void 0),this.transInstr.push(e),this.nextTrns(),i}success(e,t){if(null!==this.transInstr){if(this.init=!0,t.done&&t.done(e.hasCompleted,e.requiresTransition,e.enteringView,e.leavingView,e.direction),t.resolve(e.hasCompleted),!1!==t.opts.updateURL&&this.useRouter){const t=document.querySelector("ion-router");if(t){const i="back"===e.direction?-1:1;t.navChanged(i)}}}else this.fireError("nav controller was destroyed",t)}failed(e,t){null!==this.transInstr?(this.transInstr.length=0,this.fireError(e,t)):this.fireError("nav controller was destroyed",t)}fireError(e,t){t.done&&t.done(!1,!1,e),t.reject&&!this.destroyed?t.reject(e):t.resolve(!1)}nextTrns(){if(this.isTransitioning)return!1;const e=this.transInstr.shift();return!!e&&(this.runTransition(e),!0)}async runTransition(e){try{this.ionNavWillChange.emit(),this.isTransitioning=!0,this.prepareTI(e);const t=this.getActive(),i=this.getEnteringView(e,t);if(!t&&!i)throw new Error("no views in the stack to be removed");i&&1===i.state&&await i.init(this.el),this.postViewInit(i,t,e);const n=(e.enteringRequiresTransition||e.leavingRequiresTransition)&&i!==t?await this.transition(i,t,e):{hasCompleted:!0,requiresTransition:!1};this.success(n,e),this.ionNavDidChange.emit()}catch(t){this.failed(t,e)}this.isTransitioning=!1,this.nextTrns()}prepareTI(e){const t=this.views.length;if(e.opts=e.opts||{},void 0===e.opts.delegate&&(e.opts.delegate=this.delegate),null!=e.removeView){e.removeStart,e.removeCount;const t=this.views.indexOf(e.removeView);if(t<0)throw new Error("removeView was not found");e.removeStart+=t}null!=e.removeStart&&(e.removeStart<0&&(e.removeStart=t-1),e.removeCount<0&&(e.removeCount=t-e.removeStart),e.leavingRequiresTransition=e.removeCount>0&&e.removeStart+e.removeCount===t),e.insertViews&&((e.insertStart<0||e.insertStart>t)&&(e.insertStart=t),e.enteringRequiresTransition=e.insertStart===t);const i=e.insertViews;if(!i)return;i.length;const n=i.map(e=>e instanceof a?e:"page"in e?l(e.page,e.params):l(e,void 0)).filter(e=>null!==e);if(0===n.length)throw new Error("invalid views to insert");for(const t of n){t.delegate=e.opts.delegate;const i=t.nav;if(i&&i!==this)throw new Error("inserted view was already inserted");if(3===t.state)throw new Error("inserted view was already destroyed")}e.insertViews=n}getEnteringView(e,t){const i=e.insertViews;if(i)return i[i.length-1];const n=e.removeStart;if(null!=n){const i=this.views,s=n+e.removeCount;for(let e=i.length-1;e>=0;e--){const r=i[e];if((e<n||e>=s)&&r!==t)return r}}}postViewInit(e,t,i){i.resolve,i.reject;const s=i.opts,r=i.insertViews,o=i.removeStart,a=i.removeCount;let h=void 0;if(null!=o&&null!=a){h=[];for(let i=0;i<a;i++){const n=this.views[i+o];n&&n!==e&&n!==t&&h.push(n)}s.direction=s.direction||"back"}if(0===this.views.length+(r?r.length:0)-(a||0))throw console.warn("You can't remove all the pages in the navigation stack. nav.pop() is probably called too many times.",this,this.el),new Error("navigation stack needs at least one root page");if(r){let e=i.insertStart;for(const t of r)this.insertViewAt(t,e),e++;i.enteringRequiresTransition&&(s.direction=s.direction||"forward")}if(h&&h.length>0){for(const e of h)n(this.win,e.element,"ionViewWillLeave"),n(this.win,e.element,"ionViewDidLeave"),n(this.win,e.element,"ionViewWillUnload");for(const e of h)this.destroyView(e)}}async transition(e,t,i){this.sbTrns&&(this.sbTrns.destroy(),this.sbTrns=void 0);const n=i.opts,r=this.getAnimationBuilder(n),o=n.progressAnimation?e=>this.sbTrns=e:void 0,a=e.element,h=t&&t.element,l={animationCtrl:this.animationCtrl,animationBuilder:r,animation:void 0,direction:n.direction,duration:n.duration,easing:n.easing,viewIsReady:n.viewIsReady,showGoBack:this.canGoBack(e),progressAnimation:o,window:this.win,baseEl:this.el,enteringEl:a,leavingEl:h},d=await s(l);return this.transitionFinish(d,e,t,n)}transitionFinish(e,t,i,n){const s=!e||e.hasCompleted,r=s?t:i;return r&&this.cleanup(r),e&&e.destroy(),{hasCompleted:s,requiresTransition:!0,enteringView:t,leavingView:i,direction:n.direction}}getAnimationBuilder(e){if(0!==e.duration&&!1!==e.animate&&this.init&&!1!==this.animated&&!(this.views.length<=1))return"ios"===(e.animation||this.config.get("pageTransition",this.mode))?r:o}insertViewAt(e,t){const i=this.views,n=i.indexOf(e);n>-1?(e.nav,i.splice(t,0,i.splice(n,1)[0])):(e.nav,e.nav=this,i.splice(t,0,e))}removeView(e){2===e.state||e.state;const t=this.views,i=t.indexOf(e);i>=0&&t.splice(i,1)}destroyView(e){e._destroy(),this.removeView(e)}cleanup(e){if(this.destroyed)return;const t=this.views,i=t.indexOf(e);for(let e=t.length-1;e>=0;e--){const s=t[e];e>i?(n(this.win,s.element,"ionViewWillUnload"),this.destroyView(s)):e<i&&(s.element.hidden=!0)}}swipeBackStart(){this.isTransitioning||this.transInstr.length>0||this.queueTrns({removeStart:-1,removeCount:1,opts:{direction:"back",progressAnimation:!0}},void 0)}swipeBackProgress(e){if(this.sbTrns){this.isTransitioning=!0;const t=e.deltaX/window.innerWidth;this.sbTrns.progressStep(t)}}swipeBackEnd(e){if(this.sbTrns){const t=e.deltaX,i=window.innerWidth,n=t/i,s=e.velocityX,r=i/2,o=s>=0&&(s>.2||e.deltaX>r),a=(o?1-n:n)*i;let h=0;if(a>5){const e=a/Math.abs(s);h=Math.min(e,300)}this.sbTrns.progressEnd(o,n,h)}}canSwipeBack(){return this.swipeBackEnabled&&!this.isTransitioning&&this.canGoBack()}render(){return[this.swipeBackEnabled&&e("ion-gesture",{canStart:this.canSwipeBack.bind(this),onStart:this.swipeBackStart.bind(this),onMove:this.swipeBackProgress.bind(this),onEnd:this.swipeBackEnd.bind(this),gestureName:"goback-swipe",gesturePriority:10,type:"pan",direction:"x",threshold:10,attachTo:"body"}),"ios"===this.mode&&e("div",{class:"nav-decor"}),e("slot",null)]}static get is(){return"ion-nav"}static get properties(){return{animated:{type:Boolean,attr:"animated",mutable:!0},animationCtrl:{connect:"ion-animation-controller"},canGoBack:{method:!0},config:{context:"config"},delegate:{type:"Any",attr:"delegate"},el:{elementRef:!0},getActive:{method:!0},getByIndex:{method:!0},getPrevious:{method:!0},getRouteId:{method:!0},insert:{method:!0},insertPages:{method:!0},length:{method:!0},pop:{method:!0},popTo:{method:!0},popToRoot:{method:!0},push:{method:!0},queue:{context:"queue"},removeIndex:{method:!0},root:{type:String,attr:"root",watchCallbacks:["rootChanged"]},rootParams:{type:"Any",attr:"root-params"},setPages:{method:!0},setRoot:{method:!0},setRouteId:{method:!0},swipeBackEnabled:{type:Boolean,attr:"swipe-back-enabled",mutable:!0},win:{context:"window"}}}static get events(){return[{name:"ionNavWillChange",method:"ionNavWillChange",bubbles:!0,cancelable:!0,composed:!0},{name:"ionNavDidChange",method:"ionNavDidChange",bubbles:!0,cancelable:!0,composed:!0}]}}export{d as IonNav};